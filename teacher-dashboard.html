<section id="student-management" class="mt-10">
    <h2 class="text-xl font-bold mb-4">Add Students</h2>
    <div class="grid md:grid-cols-2 gap-6">
        <!-- Individual Entry -->
        <form id="add-student-form" class="border rounded p-4 bg-white">
            <h3 class="font-semibold mb-2">Individual Entry</h3>
            <input id="stu-name" class="input" placeholder="Student Name" required>
            <input id="stu-id" class="input mt-2" placeholder="Student ID" required>
            <input id="stu-grade" class="input mt-2" placeholder="Grade/Class">
            <input id="stu-email" class="input mt-2" placeholder="Email (optional)">
            <div class="text-sm text-gray-600 mt-2">Password will be auto-generated.</div>
            <button type="submit" class="btn-primary mt-3">Create</button>
            <div id="add-student-result" class="text-sm mt-2"></div>
        </form>

        <!-- CSV Import -->
        <div class="border rounded p-4 bg-white">
            <h3 class="font-semibold mb-2">Bulk Import (CSV)</h3>
            <input type="file" id="student-csv" accept=".csv" class="block">
            <button id="process-csv" class="btn-secondary mt-3">Import</button>
            <div id="csv-preview" class="mt-2 text-sm"></div>
        </div>
    </div>
</section>
<script>
(() => {
    const teacherId = localStorage.getItem('sv_current_user');
    const nameInput = document.getElementById('stu-name');
    const idInput = document.getElementById('stu-id');
    const gradeInput = document.getElementById('stu-grade');
    const emailInput = document.getElementById('stu-email');
    const resultDiv = document.getElementById('add-student-result');
    const csvPreview = document.getElementById('csv-preview');
    document.getElementById('add-student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = { name: nameInput.value, studentId: idInput.value, grade: gradeInput.value, email: emailInput.value || null };
        const res = await Auth.createStudentAccount(payload, teacherId);
        resultDiv.textContent = res.success ? `Created. Username: ${res.credentials.username}, Password: ${res.credentials.password}` : res.error;
    });
    document.getElementById('process-csv').onclick = async () => {
        const file = document.getElementById('student-csv').files[0];
        if (!file) return;
        const text = await file.text();
        const rows = text.trim().split(/\r?\n/).slice(1).map(l => { const [name, studentId, grade, email] = l.split(','); return { name, studentId, grade, email }; });
        const results = await Auth.bulkCreateStudents(rows, teacherId);
        csvPreview.textContent = `${results.filter(r => r.success).length} created, ${results.filter(r => !r.success).length} failed`;
    };
})();
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - STEM Village</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/learning/gamified6-12/css/teacher-analytics.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/learning/gamified6-12/js/teacher-analytics.js"></script>
    <script src="/learning/gamified6-12/js/csv-exporter.js"></script>
    <script src="/learning/gamified6-12/js/adaptive-difficulty-tracker.js"></script>
    <script src="/learning/gamified6-12/js/i18n.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Accessibility & Inclusivity Header -->
    <header class="flex justify-between items-center px-4 py-2 bg-green-50">
        <div id="lang-toggle" class="mr-4 flex items-center"></div>
        <div class="flex gap-2 items-center">
            <!-- Teacher analytics filters and controls go here -->
        </div>
    </header>
    <!-- Sidebar -->
    <div class="flex h-screen overflow-hidden">
        <div class="hidden md:flex md:flex-shrink-0">
            <div class="flex flex-col w-64 bg-green-700 text-white">
                <div class="flex items-center justify-center h-16 px-4 bg-green-800">
                    <img src="/static/logo-white.png" alt="STEM Village" class="h-10">
                </div>
                <div class="flex flex-col flex-grow px-4 py-4 overflow-y-auto">
                    <div class="flex items-center px-4 py-3 mb-2 rounded-lg bg-green-800">
                        <img class="w-10 h-10 rounded-full" src="http://static.photos/people/200x200/6" alt="Teacher">
                        <div class="ml-3">
                            <p class="font-medium">Priya Sharma</p>
                            <p class="text-sm text-green-200">Math Teacher</p>
                        </div>
                    </div>
                    
                    <nav class="flex-1 space-y-2">
                        <a href="#" class="flex items-center px-4 py-3 text-white bg-green-800 rounded-lg">
                            <i data-feather="home" class="w-5 h-5"></i>
                            <span class="ml-3">Dashboard</span>
                        </a>
                        <a href="/teacher-classes.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="users" class="w-5 h-5"></i>
                            <span class="ml-3">My Classes</span>
                        </a>
                        <a href="/teacher-progress.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                            <span class="ml-3">Progress Reports</span>
                        </a>
                        <a href="/teacher-assignments.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="book" class="w-5 h-5"></i>
                            <span class="ml-3">Assignments</span>
                        </a>
                        <a href="/teacher-resources.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="folder" class="w-5 h-5"></i>
                            <span class="ml-3">Resources</span>
                        </a>
                    </nav>
                    
                    <div class="mt-auto pb-4">
                        <a href="/teacher-settings.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="settings" class="w-5 h-5"></i>
                            <span class="ml-3">Settings</span>
                        </a>
                        <a href="/logout.html" class="flex items-center px-4 py-3 text-green-200 hover:text-white hover:bg-green-800 rounded-lg transition duration-300">
                            <i data-feather="log-out" class="w-5 h-5" aria-hidden="true"></i>
                            <span class="ml-3" data-i18n="sidebar_logout" aria-label="Logout">Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Mobile Header -->
            <div class="md:hidden flex items-center justify-between px-4 py-3 bg-green-700 text-white">
                <button class="text-white focus:outline-none">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>
                <img src="/static/logo-white.png" alt="STEM Village" class="h-8">
                <div class="w-6"></div>
            </div>
            
            <!-- Main Content Area -->
            <div class="flex-1 overflow-auto p-4 md:p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Enhanced Analytics Header -->
                    <div class="bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-6 text-white mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-2xl font-bold mb-2" data-i18n="analytics.dashboard">Analytics Dashboard</h1>
                            <p class="text-green-100" data-i18n="analytics.help.analytics">View detailed analytics and reports for your class.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="class-filter" class="rounded px-3 py-2 text-gray-800">
                                <option value="all">All Classes</option>
                                <option value="8A">Grade 8A</option>
                                <option value="8B">Grade 8B</option>
                            </select>
                            <select id="date-range" class="rounded px-3 py-2 text-gray-800">
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                            </select>
                            <button class="export-btn flex items-center" id="export-csv-btn"><i data-feather="download" class="w-4 h-4 mr-1"></i><span data-i18n="analytics.exportCSV">Export to CSV</span></button>
                        </div>
                    </div>
                    <!-- Analytics Charts Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="analytics-card">
                            <h2 class="font-bold mb-2" data-i18n="analytics.performanceTrends">Performance Trends</h2>
                            <div class="chart-container"><canvas id="performance-trend-chart"></canvas></div>
                        </div>
                        <div class="analytics-card">
                            <h2 class="font-bold mb-2" data-i18n="analytics.subjectComparison">Subject Comparison</h2>
                            <div class="chart-container"><canvas id="subject-comparison-chart"></canvas></div>
                        </div>
                        <div class="analytics-card">
                            <h2 class="font-bold mb-2" data-i18n="analytics.engagementLevels">Engagement Levels</h2>
                            <div class="chart-container"><canvas id="engagement-heatmap"></canvas></div>
                        </div>
                        <div class="analytics-card">
                            <h2 class="font-bold mb-2" data-i18n="analytics.difficultyProgression">Difficulty Progression</h2>
                            <div class="chart-container"><canvas id="difficulty-progression-chart"></canvas></div>
                        </div>
                    </div>
                    <!-- Class-wise Progress Visualization -->
                    <div class="class-comparison mb-6">
                        <div class="class-comparison-card">
                            <h3 class="font-bold mb-2" data-i18n="analytics.classOverview">Class Overview</h3>
                            <div id="class-overview"></div>
                        </div>
                        <div class="class-comparison-card">
                            <h3 class="font-bold mb-2" data-i18n="analytics.studentAnalytics">Student Analytics</h3>
                            <div id="student-analytics"></div>
                        </div>
                        <div class="class-comparison-card">
                            <h3 class="font-bold mb-2" data-i18n="analytics.subjectComparison">Subject Mastery</h3>
                            <div id="subject-mastery"></div>
                        </div>
                    </div>
                    <!-- Weak Topic Identification Dashboard -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4" data-i18n="analytics.weakTopics">Weak Topics</h2>
                        <div id="weak-topics-list"></div>
                    </div>
                    <!-- Enhanced Recent Activity Table -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold" data-i18n="analytics.recentActivity">Recent Student Activity</h2>
                            <a href="/teacher-progress.html" class="text-green-600 hover:text-green-800 text-sm font-medium">View All</a>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="data-table min-w-full">
                                <thead>
                                    <tr>
                                        <th data-i18n="analytics.studentList">Student</th>
                                        <th data-i18n="analytics.activityHistory">Activity</th>
                                        <th data-i18n="analytics.subjectComparison">Subject</th>
                                        <th data-i18n="analytics.scoreDistribution">Score</th>
                                        <th data-i18n="analytics.timeSpent">Time</th>
                                        <th data-i18n="analytics.difficultyAdjustment">Difficulty</th>
                                        <th data-i18n="analytics.action">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <script>
                    // Real-time activity event wiring for dashboard
                    document.addEventListener('DOMContentLoaded', async function() {
                        // Subscribe to activity events for live updates
                        TeacherAnalytics.subscribeToActivityEvents(async (activity) => {
                            if (activity === 'refresh') {
                                // Refresh Recent Activity table
                                const events = await Offline.bulkGet('activity_events');
                                const tbody = document.getElementById('activity-table-body');
                                tbody.innerHTML = events.slice(-20).reverse().map(ev => `
                                    <tr>
                                        <td>${ev.studentName || ev.studentId}</td>
                                        <td>${ev.activityType || ev.type}</td>
                                        <td>${ev.subject || ''}</td>
                                        <td>${ev.score ?? ''}</td>
                                        <td>${ev.timeSpent || ev.duration || ''}</td>
                                        <td>${ev.difficulty || ''}</td>
                                        <td><button class="text-blue-600 underline" onclick="TeacherAnalytics.showStudentReport('${ev.studentId}')">View</button></td>
                                    </tr>
                                `).join('');
                            }
                        });
                        // Initial table fill
                        const events = await Offline.bulkGet('activity_events');
                        const tbody = document.getElementById('activity-table-body');
                        tbody.innerHTML = events.slice(-20).reverse().map(ev => `
                            <tr>
                                <td>${ev.studentName || ev.studentId}</td>
                                <td>${ev.activityType || ev.type}</td>
                                <td>${ev.subject || ''}</td>
                                <td>${ev.score ?? ''}</td>
                                <td>${ev.timeSpent || ev.duration || ''}</td>
                                <td>${ev.difficulty || ''}</td>
                                <td><button class="text-blue-600 underline" onclick="TeacherAnalytics.showStudentReport('${ev.studentId}')">View</button></td>
                            </tr>
                        `).join('');
                    });
                    </script>
                    <!-- CSV Export Interface -->
                    <div class="export-controls mb-6">
                        <label><input type="checkbox" checked> <span data-i18n="analytics.studentProgress">Student Progress</span></label>
                        <label><input type="checkbox" checked> <span data-i18n="analytics.classOverview">Class Overview</span></label>
                        <label><input type="checkbox"> <span data-i18n="analytics.weakTopics">Weak Topics</span></label>
                        <label><input type="checkbox"> <span data-i18n="analytics.engagementLevels">Engagement</span></label>
                        <label><input type="checkbox"> <span data-i18n="analytics.difficultyProgression">Difficulty</span></label>
                        <button class="export-btn" id="custom-export-btn"><i data-feather="download" class="w-4 h-4 mr-1"></i><span data-i18n="analytics.generateReport">Generate Report</span></button>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Class Performance -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Class Performance</h2>
                                <div class="text-green-600 bg-green-100 px-2 py-1 rounded-full text-xs font-medium">+12%</div>
                            </div>
                            <div class="h-40">
                                <!-- Chart placeholder -->
                                <div class="flex items-end h-32 space-x-1">
                                    <div class="w-1/5 bg-green-200 h-16 rounded-t"></div>
                                    <div class="w-1/5 bg-green-300 h-20 rounded-t"></div>
                                    <div class="w-1/5 bg-green-400 h-24 rounded-t"></div>
                                    <div class="w-1/5 bg-green-500 h-28 rounded-t"></div>
                                    <div class="w-1/5 bg-green-600 h-32 rounded-t"></div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Average score improvement this month</p>
                        </div>
                        
                        <!-- Active Students -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Active Students</h2>
                                <div class="text-blue-600 bg-blue-100 px-2 py-1 rounded-full text-xs font-medium">38/48</div>
                            </div>
                            <div class="flex items-center justify-center h-32">
                                <div class="relative w-24 h-24">
                                    <svg class="w-full h-full" viewBox="0 0 36 36">
                                        <path d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="#e6e6e6"
                                            stroke-width="3"
                                            stroke-dasharray="100, 100"
                                        />
                                        <path d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="#3b82f6"
                                            stroke-width="3"
                                            stroke-dasharray="79, 100"
                                        />
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span class="text-2xl font-bold">79%</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Active in the last 7 days</p>
                        </div>
                        
                        <!-- Assignments Due -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Assignments Due</h2>
                                <div class="text-red-600 bg-red-100 px-2 py-1 rounded-full text-xs font-medium">3</div>
                            </div>
                            <div class="space-y-4 h-32 overflow-y-auto">
                                <div class="flex items-start">
                                    <div class="bg-green-100 p-2 rounded-lg mr-3">
                                        <i data-feather="book" class="w-4 h-4 text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Algebra Quiz</p>
                                        <p class="text-xs text-gray-600">Due tomorrow</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                        <i data-feather="edit" class="w-4 h-4 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Science Project</p>
                                        <p class="text-xs text-gray-600">Due in 3 days</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                        <i data-feather="code" class="w-4 h-4 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Coding Challenge</p>
                                        <p class="text-xs text-gray-600">Due in 5 days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Recent Student Activity</h2>
                            <a href="/teacher-progress.html" class="text-green-600 hover:text-green-800 text-sm font-medium">View All</a>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="http://static.photos/people/200x200/7" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">Rahul Kumar</div>
                                                    <div class="text-sm text-gray-500">Grade 8A</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">Algebra Quiz</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Math</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex items-center">
                                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                                    <div class="bg-green-600 h-2 rounded-full" style="width: 85%"></div>
                                                </div>
                                                <span>85%</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            2 hours ago
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="http://static.photos/people/200x200/8" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">Priya Patel</div>
                                                    <div class="text-sm text-gray-500">Grade 8B</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">Chemical Reactions</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Science</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex items-center">
                                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                                    <div class="bg-green-600 h-2 rounded-full" style="width: 92%"></div>
                                                </div>
                                                <span>92%</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            5 hours ago
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="http://static.photos/people/200x200/9" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">Amit Singh</div>
                                                    <div class="text-sm text-gray-500">Grade 8A</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">Python Basics</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Technology</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex items-center">
                                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                                    <div class="bg-green-600 h-2 rounded-full" style="width: 78%"></div>
                                                </div>
                                                <span>78%</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            1 day ago
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Your Classes -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Your Classes</h2>
                            <a href="/teacher-classes.html" class="text-green-600 hover:text-green-800 text-sm font-medium">View All</a>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4">
                            <!-- Class 1 -->
                            <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition duration-300">
                                <div class="h-32 bg-blue-100 flex items-center justify-center">
                                    <i data-feather="book" class="w-10 h-10 text-blue-600"></i>
                                </div>
                                <div class="p-4">
                                    <h3 class="font-bold mb-1">Grade 8A - Mathematics</h3>
                                    <p class="text-sm text-gray-600 mb-3">24 students</p>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i data-feather="activity" class="w-4 h-4 mr-1 text-green-600"></i>
                                            <span>78% avg</span>
                                        </div>
                                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800">View Class</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Class 2 -->
                            <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition duration-300">
                                <div class="h-32 bg-green-100 flex items-center justify-center">
                                    <i data-feather="flask" class="w-10 h-10 text-green-600"></i>
                                </div>
                                <div class="p-4">
                                    <h3 class="font-bold mb-1">Grade 8B - Science</h3>
                                    <p class="text-sm text-gray-600 mb-3">22 students</p>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i data-feather="activity" class="w-4 h-4 mr-1 text-green-600"></i>
                                            <span>82% avg</span>
                                        </div>
                                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800">View Class</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Class 3 -->
                            <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition duration-300">
                                <div class="h-32 bg-purple-100 flex items-center justify-center">
                                    <i data-feather="plus" class="w-10 h-10 text-purple-600"></i>
                                </div>
                                <div class="p-4 flex items-center justify-center h-full">
                                    <button class="text-purple-600 hover:text-purple-800 font-medium">
                                        <i data-feather="plus" class="w-5 h-5 mr-2"></i>
                                        Add New Class
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Assignment Creation Section -->
        <div class="mt-12 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <button class="w-full text-left font-bold text-lg mb-4" onclick="document.getElementById('assignment-create-panel').classList.toggle('hidden')">
                    <i data-feather="edit-3" class="mr-2"></i><span data-i18n="assignment.create.title">Create Assignment</span>
                </button>
                <div id="assignment-create-panel" class="hidden">
                    <form id="assignment-create-form" class="space-y-4">
                        <div>
                            <label class="block font-medium mb-1" for="assignment-title" data-i18n="assignment.create.title">Assignment Title</label>
                            <input type="text" id="assignment-title" name="title" required class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium mb-1" for="assignment-desc" data-i18n="assignment.create.description">Description</label>
                            <textarea id="assignment-desc" name="description" rows="3" class="w-full border rounded px-3 py-2"></textarea>
                        </div>
                        <div>
                            <label class="block font-medium mb-1" for="assignment-subject" data-i18n="assignment.create.subject">Subject</label>
                            <select id="assignment-subject" name="subject" class="w-full border rounded px-3 py-2">
                                <option value="math">Mathematics</option>
                                <option value="physics">Physics</option>
                                <option value="chemistry">Chemistry</option>
                                <option value="biology">Biology</option>
                                <option value="technology">Technology</option>
                                <option value="engineering">Engineering</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-1" for="assignment-due" data-i18n="assignment.create.dueDate">Due Date</label>
                            <input type="datetime-local" id="assignment-due" name="dueDate" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium mb-1" data-i18n="assignment.create.submissionMode">Submission Mode</label>
                            <select id="assignment-mode" name="submissionMode" class="w-full border rounded px-3 py-2">
                                <option value="online">Online (File Upload)</option>
                                <option value="offline">Offline Submission</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-1" data-i18n="assignment.create.type">Assignment Type</label>
                            <select id="assignment-type" name="type" class="w-full border rounded px-3 py-2">
                                <option value="individual">Individual</option>
                                <option value="group">Group</option>
                                <option value="project">Project</option>
                                <option value="quiz">Quiz</option>
                            </select>
                        </div>
                        <!-- Student Selection Panel -->
                        <div class="mt-6">
                            <button type="button" class="font-bold mb-2" onclick="document.getElementById('student-select-panel').classList.toggle('hidden')">
                                <i data-feather="users" class="mr-2"></i><span data-i18n="assignment.create.students">Select Students</span>
                            </button>
                            <div id="student-select-panel" class="hidden border rounded p-4 bg-gray-50">
                                <div class="flex gap-2 mb-2">
                                    <button type="button" id="select-all-students" class="px-2 py-1 bg-blue-100 rounded">Select All</button>
                                    <button type="button" id="select-none-students" class="px-2 py-1 bg-gray-200 rounded">Select None</button>
                                    <select id="class-select" class="ml-4 px-2 py-1 border rounded">
                                        <option value="">All Classes</option>
                                        <option value="8A">Grade 8A</option>
                                        <option value="8B">Grade 8B</option>
                                        <!-- More classes dynamically -->
                                    </select>
                                    <input type="text" id="student-search" placeholder="Search students..." class="ml-4 px-2 py-1 border rounded">
                                </div>
                                <div id="student-list" class="max-h-48 overflow-y-auto grid grid-cols-2 gap-2"></div>
                                <div class="mt-2 text-sm text-gray-600">
                                    <span id="selected-student-count">0</span> students selected
                                </div>
                                <div id="selected-student-preview" class="mt-2 text-xs text-blue-600"></div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Create Assignment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Assignment Management Dashboard -->
        <div class="mb-12">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="font-bold text-xl mb-4" data-i18n="assignment.teacher.myAssignments">My Assignments</h2>
                <div id="assignment-dashboard" class="grid md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- Real-time Status Indicators -->
        <div class="mb-12">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="font-bold text-xl mb-4">Assignment Delivery Status</h2>
                <div id="assignment-status-indicators" class="grid md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <script src="/learning/gamified6-12/js/assignment-manager.js"></script>
        <script src="/learning/gamified6-12/js/assignment-sync.js"></script>
        <script>
        feather.replace();
        i18n.init();
        // Analytics dashboard JS init
        document.addEventListener('DOMContentLoaded', async function() {
            await TeacherAnalytics.init();
            // Chart.js chart instances
            let perfChart, subjChart, engagementChart, diffChart;
            let selectedClass = 'all';
            const classFilter = document.getElementById('class-filter');
            if (classFilter) {
                classFilter.addEventListener('change', async (e) => {
                    selectedClass = e.target.value;
                    await renderCharts();
                });
            }
            async function renderCharts() {
                // 1. Performance Trend Chart
                const perfTrend = await TeacherAnalytics.generatePerformanceTrendChart(selectedClass);
                const ctx1 = document.getElementById('performance-trend-chart').getContext('2d');
                if (perfChart) perfChart.destroy();
                perfChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: perfTrend.map((_, i) => `Week ${i+1}`),
                        datasets: [{ label: 'Avg Score', data: perfTrend, borderColor: '#10b981', fill: false }]
                    },
                    options: { responsive: true }
                });
                // 2. Subject Comparison Chart (Activity Frequency)
                const subjFreq = await TeacherAnalytics.getSubjectActivityFrequency(selectedClass);
                const ctx2 = document.getElementById('subject-comparison-chart').getContext('2d');
                if (subjChart) subjChart.destroy();
                subjChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(subjFreq),
                        datasets: [{ label: 'Activity Frequency', data: Object.values(subjFreq), backgroundColor: ['#10b981','#3b82f6','#f59e42','#a78bfa','#f43f5e'] }]
                    },
                    options: { indexAxis: 'y', responsive: true }
                });
                // 3. Engagement Heatmap
                const engagement = await TeacherAnalytics.generateEngagementChart(selectedClass);
                const ctx3 = document.getElementById('engagement-heatmap').getContext('2d');
                if (engagementChart) engagementChart.destroy();
                engagementChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: engagement.map((_, i) => `Student ${i+1}`),
                        datasets: [{ label: 'Engagement', data: engagement, backgroundColor: '#059669' }]
                    },
                    options: { responsive: true }
                });
                // 4. Difficulty Progression
                const diffProg = await TeacherAnalytics.generateDifficultyProgressionChart(selectedClass);
                const ctx4 = document.getElementById('difficulty-progression-chart').getContext('2d');
                if (diffChart) diffChart.destroy();
                diffChart = new Chart(ctx4, {
                    type: 'line',
                    data: {
                        labels: diffProg.map((_, i) => `Session ${i+1}`),
                        datasets: [{ label: 'Difficulty', data: diffProg.map(d => d.difficulty || 0), borderColor: '#f59e42', fill: false }]
                    },
                    options: { responsive: true }
                });
            }
            // Initial chart render
            await renderCharts();
            // Refresh charts on sv-activity event
            TeacherAnalytics.subscribeToActivityEvents(async (activity) => {
                if (activity === 'refresh') await renderCharts();
            });
            // --- Fill Weak Topics List ---
            async function renderWeakTopics() {
                const weakTopics = await TeacherAnalytics.getWeakTopics();
                const weakList = document.getElementById('weak-topics-list');
                weakList.innerHTML = weakTopics.length ? '<ul>' + weakTopics.map(t => `<li class="mb-2"><span class="font-bold">${t.topic}</span>: <span class="text-red-600">${Math.round(t.avgScore)}%</span></li>`).join('') + '</ul>' : '<span>No weak topics detected.</span>';
            }
            await renderWeakTopics();
            TeacherAnalytics.subscribeToActivityEvents(async (activity) => {
                if (activity === 'refresh') await renderWeakTopics();
            });
            // --- CSV Export Buttons ---
            document.getElementById('export-csv-btn').onclick = () => {
                // Export recent activity as CSV
                TeacherAnalytics.getRecentActivity(100).then(activity => {
                    const csv = [
                        'Student ID,Student Name,Type,Subject,Score,Time Spent,Difficulty,Class ID,Timestamp',
                        ...activity.map(ev => [ev.studentId, ev.studentName, ev.type, ev.subject, ev.score, ev.timeSpent, ev.difficulty, ev.classId, ev.timestamp].join(','))
                    ].join('\n');
                    CSVExporter.downloadCSV('activity_events.csv', csv);
                });
            };
            document.getElementById('custom-export-btn').onclick = () => {
                // Export weak topics as CSV
                TeacherAnalytics.getWeakTopics().then(topics => {
                    const csv = [
                        'Topic,Average Score,Count,Fail Rate',
                        ...topics.map(t => [t.topic, Math.round(t.avgScore), t.count, t.failRate].join(','))
                    ].join('\n');
                    CSVExporter.downloadCSV('weak_topics.csv', csv);
                });
            };
        });
        </script>
</body>
</html>